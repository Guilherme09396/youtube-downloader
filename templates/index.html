<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Youtube Downloader</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <div class="container">
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="logo">
    <h1>Youtube Downloader</h1>

    <div class="section">
      <h2>Baixar um v√≠deo</h2>
      <input type="text" id="url" placeholder="Cole o link do YouTube">
      <select id="format">
        <option value="mp3">MP3 (√Åudio)</option>
        <option value="mp4">MP4 (V√≠deo)</option>
      </select>
      <input type="text" id="token" placeholder="Token de acesso">
      <button id="btnDownload">Baixar</button>
      <p id="singleStatus"></p>
    </div>

    <div class="section">
      <h2>Upload de .txt (v√°rios links)</h2>
      <input type="file" id="fileTxt" accept=".txt">
      <button id="btnUpload">Enviar .txt</button>
      <p id="uploadStatus"></p>
    </div>

    <div class="section">
      <h2>Jobs ativos</h2>
      <ul id="jobsList"></ul>
    </div>

    <footer>
      Feito com üíö em Flask | Uso pessoal
    </footer>
  </div>

<script>
const jobsList = document.getElementById("jobsList");
const polling = {};

async function trackJob(job_id) {
  addJobUI(job_id);
  if (polling[job_id]) return;
  polling[job_id] = true;
  const token = document.getElementById("token").value.trim();
  while(true) {
    await new Promise(r => setTimeout(r, 1500));
    const resp = await fetch(`/api/status/${job_id}`, {
      headers: { "X-Auth-Token": token }
    });
    if (!resp.ok) break;
    const json = await resp.json();
    const el = document.querySelector("#job-" + job_id + " .status");
    if (el) el.textContent = json.status || "unknown";
    if (json.status === "done") {
      const dl = document.querySelector("#job-" + job_id + " .downloadlink");
      if (dl) dl.href = `/api/result/${job_id}?token=${token}`;
      break;
    } else if (json.status === "error") {
      break;
    }
  }
  polling[job_id] = false;
}

function addJobUI(job_id) {
  if (document.getElementById("job-" + job_id)) return;
  const li = document.createElement("li");
  li.id = "job-" + job_id;
  li.innerHTML = `<strong>${job_id}</strong> ‚Äî <span class="status">queued</span> ‚Äî <a class="downloadlink" href="#">baixar</a>`;
  jobsList.appendChild(li);
}

document.getElementById("btnDownload").onclick = async () => {
  const url = document.getElementById("url").value.trim();
  const formato = document.getElementById("format").value;
  const token = document.getElementById("token").value.trim();
  if (!url || !token) return alert("Informe link e token");
  const resp = await fetch("/api/download", {
    method: "POST",
    headers: { "Content-Type":"application/json", "X-Auth-Token": token },
    body: JSON.stringify({ url, formato })
  });
  const json = await resp.json();
  if (!resp.ok) return alert(JSON.stringify(json));
  trackJob(json.job_id);
}

document.getElementById("btnUpload").onclick = async () => {
  const file = document.getElementById("fileTxt").files[0];
  const token = document.getElementById("token").value.trim();
  if (!file || !token) return alert("Selecione arquivo e token");
  const fd = new FormData();
  fd.append("file", file);
  const resp = await fetch("/api/upload_txt", {
    method: "POST",
    headers: { "X-Auth-Token": token },
    body: fd
  });
  const json = await resp.json();
  if (!resp.ok) return alert(JSON.stringify(json));
  json.jobs.forEach(j => trackJob(j));
}
</script>

</body>
</html>
