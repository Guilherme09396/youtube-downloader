<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Youtube Downloader Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<div class="container">
  <header>
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="logo">
    <h1>Youtube Downloader</h1>
  </header>

  <section class="section">
    <h2>📥 Baixar um vídeo</h2>
    <input type="text" id="url" placeholder="Cole o link do YouTube">
    <select id="format">
      <option value="mp3">MP3 (Áudio)</option>
      <option value="mp4">MP4 (Vídeo)</option>
    </select>
    <input type="text" id="token" placeholder="Token de acesso">
    <button id="btnDownload"><i class="fas fa-download"></i> Baixar</button>
    <p id="singleStatus" class="status-msg"></p>
  </section>

  <section class="section">
    <h2>📄 Upload de .txt (vários links)</h2>
    <input type="file" id="fileTxt" accept=".txt">
    <button id="btnUpload"><i class="fas fa-upload"></i> Enviar .txt</button>
    <p id="uploadStatus" class="status-msg"></p>
  </section>

  <section class="section">
    <h2>📋 Jobs ativos</h2>
    <div id="jobsList" class="jobs-grid"></div>
  </section>

  <footer>
    Feito com 💚 em Flask | Uso pessoal
  </footer>
</div>

<script>
const jobsList = document.getElementById("jobsList");
const polling = {};

function addJobUI(job_id, url, format, title) {
  if (document.getElementById("job-" + job_id)) return;

  const card = document.createElement("div");
  card.className = "job-card";
  card.id = "job-" + job_id;
  card.innerHTML = `
    <div class="job-header">
      <strong class="job-title">${title}</strong>
      <span class="format">${format.toUpperCase()}</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill"></div>
    </div>
    <div class="job-footer">
      <span class="status">queued</span>
      <a class="downloadlink" href="#" target="_blank"><i class="fas fa-download"></i></a>
    </div>
  `;
  jobsList.prepend(card);
}

async function trackJob(job_id) {
  if (polling[job_id]) return;
  polling[job_id] = true;

  const token = document.getElementById("token").value.trim();
  const el = document.getElementById("job-" + job_id);
  const statusEl = el.querySelector(".status");
  const progressFill = el.querySelector(".progress-fill");
  let progress = 0;

  
  while(true) {
    await new Promise(r => setTimeout(r, 1500));
    const resp = await fetch(`/api/status/${job_id}`, { headers: { "X-Auth-Token": token }});
    if (!resp.ok) break;
    const json = await resp.json();
    
    statusEl.textContent = json.status || "unknown";
    if(json.title) el.querySelector(".job-title").textContent = json.title.length > 70 ? `${json.title.slice(0, 70)}...` : json.title;
    // Atualiza status
    statusEl.textContent = json.status || "unknown";
    if(json.status === "downloading" && progress < 90) {
      progress += Math.floor(Math.random() * 15);
    } else if(json.status === "done") {
      progress = 100;
      const dl = el.querySelector(".downloadlink");
      dl.href = `/api/result/${job_id}?token=${token}`;
      break;
    } else if(json.status === "error") {
      progress = 100;
      el.querySelector(".progress-fill").style.background = "#e74c3c";
      break;
    }
    progressFill.style.width = progress + "%";
  }
  progressFill.style.width = progress + "%";
  polling[job_id] = false;
}

// Botão download único
document.getElementById("btnDownload").onclick = async () => {
  const url = document.getElementById("url").value.trim();
  const format = document.getElementById("format").value;
  const token = document.getElementById("token").value.trim();
  if (!url || !token) return alert("Informe link e token");
  const resp = await fetch("/api/download", {
    method: "POST",
    headers: { "Content-Type":"application/json", "X-Auth-Token": token },
    body: JSON.stringify({ url, formato: format })
  });
  const json = await resp.json();
  if (!resp.ok) return alert(JSON.stringify(json));
  addJobUI(json.job_id, url, format, "Carregando...");
  trackJob(json.job_id);
}

// Botão upload .txt
document.getElementById("btnUpload").onclick = async () => {
  const file = document.getElementById("fileTxt").files[0];
  const token = document.getElementById("token").value.trim();
  if (!file || !token) return alert("Selecione arquivo e token");
  const fd = new FormData();
  fd.append("file", file);
  const resp = await fetch("/api/upload_txt", { method: "POST", headers: {"X-Auth-Token": token}, body: fd });
  const json = await resp.json();
  if (!resp.ok) return alert(JSON.stringify(json));
  json.jobs.forEach(job_id => {
    addJobUI(job_id, file.name, "MP3");
    trackJob(job_id);
  });
}
</script>
</body>
</html>
